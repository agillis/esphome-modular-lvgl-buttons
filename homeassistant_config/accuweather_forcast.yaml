---
# Weather forecast template sensor for Home Assistant
# This file creates sensor.weather_forecast (also known as weather_forecast_daily_sensor)
# which ESPHome uses to display multi-day weather forecasts
#
# SETUP INSTRUCTIONS:
# 1. Copy this file to your Home Assistant config directory
# 2. Add to your configuration.yaml: template: !include accuweather_forcast.yaml
# 3. Restart Home Assistant
# 4. Verify sensor.weather_forecast exists in Developer Tools -> States
#
# REQUIREMENTS:
# - A weather entity (default: weather.home) that provides daily forecast data
# - The weather.get_forecasts service must be available
#
template:
  - trigger:
      # Trigger every hour to fetch fresh forecast data
      - trigger: time_pattern
        hours: /1
        # minutes: /1  # Uncomment for every-minute updates (testing only)
    action:
      # Call weather service to get daily forecasts
      - action: weather.get_forecasts
        data:
          type: daily  # Request daily forecast (not hourly)
        target:
          entity_id: weather.home  # Change this if your weather entity has a different name
        response_variable: hourly  # Variable name (historical - actually contains daily data)
    sensor:
      # Optional: Uncomment to create a sensor with ALL forecast data
      # - name: weather forecast all
        # unique_id: weather_forecast_all
        # state: "OK"
        # attributes:
          # forecast: "{{ hourly['weather.home']['forecast'] }}"

      # Main sensor: Weather Forecast (sensor.weather_forecast)
      # This sensor is what ESPHome reads to display the forecast
      # It extracts specific attributes for 4 days of forecast data
      - name: Weather Forecast
        unique_id: weather_forecast
        state: "OK"
        attributes:
          # Day 0 (today or tomorrow, depending on when forecast starts)
          condition_0: >
            {{ hourly["weather.home"].forecast[0].condition }}
          temperature_hi_0: >
            {{ hourly["weather.home"].forecast[0].temperature }}
          temperature_lo_0: >
            {{ hourly["weather.home"].forecast[0].templow }}
          day_0: >
            {{ as_timestamp(hourly["weather.home"].forecast[0].datetime) | timestamp_custom('%a') }}

          # Day 1
          condition_1: >
            {{ hourly["weather.home"].forecast[1].condition }}
          temperature_hi_1: >
            {{ hourly["weather.home"].forecast[1].temperature }}
          temperature_lo_1: >
            {{ hourly["weather.home"].forecast[1].templow }}
          day_1: >
            {{ as_timestamp(hourly["weather.home"].forecast[1].datetime) | timestamp_custom('%a') }}

          # Day 2
          condition_2: >
            {{ hourly["weather.home"].forecast[2].condition }}
          temperature_hi_2: >
            {{ hourly["weather.home"].forecast[2].temperature }}
          temperature_lo_2: >
            {{ hourly["weather.home"].forecast[2].templow }}
          day_2: >
            {{ as_timestamp(hourly["weather.home"].forecast[2].datetime) | timestamp_custom('%a') }}

          # Day 3
          condition_3: >
            {{ hourly["weather.home"].forecast[3].condition }}
          temperature_hi_3: >
            {{ hourly["weather.home"].forecast[3].temperature }}
          temperature_lo_3: >
            {{ hourly["weather.home"].forecast[3].templow }}
          day_3: >
            {{ as_timestamp(hourly["weather.home"].forecast[3].datetime) | timestamp_custom('%a') }}

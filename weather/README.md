# Weather Forecast Implementation

## Overview

This directory contains the ESPHome configuration for displaying weather information from Home Assistant, including current weather and multi-day forecasts.

## How `sensor.weather_forecast` is Generated

The `sensor.weather_forecast` sensor (referenced in the user query as "weather_forecast_daily_sensor") is **NOT** generated by ESPHome. Instead, it's a **Home Assistant Template Sensor** that must be configured in your Home Assistant instance.

### Configuration Location

The sensor template configuration is provided in:
- **`homeassistant_config/accuweather_forcast.yaml`** (note: filename has a typo - "forcast" instead of "forecast")

This file should be included in your Home Assistant's `configuration.yaml`:

```yaml
# In your Home Assistant configuration.yaml
template: !include accuweather_forcast.yaml
```

### How It Works

1. **Trigger**: The template sensor is triggered every hour using a time pattern trigger
2. **Data Collection**: Calls the `weather.get_forecasts` service with `type: daily` for the `weather.home` entity
3. **Sensor Creation**: Creates a sensor named "Weather Forecast" (`sensor.weather_forecast`) with attributes for 4 days of forecast data
4. **Attributes Generated**:
   - `condition_0` through `condition_3`: Weather conditions (e.g., "sunny", "cloudy")
   - `temperature_hi_0` through `temperature_hi_3`: High temperatures
   - `temperature_lo_0` through `temperature_lo_3`: Low temperatures
   - `day_0` through `day_3`: Day names (e.g., "Mon", "Tue")

### ESPHome Integration

Once the sensor exists in Home Assistant, ESPHome reads it using:
- **`weather/weather_forecast.yaml`**: Creates text sensors that monitor the attributes of `sensor.weather_forecast`
- **`weather/weather_today.yaml`**: Displays current weather from `weather.home` entity
- **`weather/weather_icons_update.yaml`**: Updates weather icons based on conditions

## Files in this Directory

### Core Configuration Files

- **`weather_forecast.yaml`**: ESPHome text sensors that read forecast attributes from `sensor.weather_forecast`
- **`weather_today.yaml`**: ESPHome text sensors for current weather from `weather.home`
- **`weather_icons.yaml`**: Weather icon image definitions (SVG-based)
- **`weather_icons_update.yaml`**: Script for updating weather icons based on conditions

### Home Assistant Configuration

- **`../homeassistant_config/accuweather_forcast.yaml`**: Home Assistant template sensor configuration (must be added to your HA instance)

## Setup Instructions

### Step 1: Configure Home Assistant

1. Copy `homeassistant_config/accuweather_forcast.yaml` to your Home Assistant config directory
2. Add this to your `configuration.yaml`:
   ```yaml
   template: !include accuweather_forcast.yaml
   ```
3. Ensure you have a weather entity named `weather.home` (or update the entity_id in the template)
4. Restart Home Assistant
5. Verify the sensor exists: Developer Tools → States → search for `sensor.weather_forecast`

### Step 2: Configure ESPHome

Include the weather packages in your ESPHome device YAML (see `example_code_advanced/SDL-weather-forcast.yaml` for a complete example - note the filename has a typo):

```yaml
packages:
  # Build icon set from .svg files
  weather_icons_80: !include
    file: esphome-modular-lvgl-buttons/weather/weather_icons.yaml
    vars:
      size: 80
  
  # Display weather forecast using icon set (package name has typo in original code)
  weather_forcast_80: !include
    file: esphome-modular-lvgl-buttons/weather/weather_forecast.yaml
    vars:
      size: 80
  
  # Big icons for today's weather
  weather_icons_200: !include
    file: esphome-modular-lvgl-buttons/weather/weather_icons.yaml
    vars:
      size: 200
  
  # Get today's weather and display it
  weather_today_200: !include
    file: esphome-modular-lvgl-buttons/weather/weather_today.yaml
    vars:
      size: 200
```

## Customization

### Change Weather Entity

If your weather entity is not named `weather.home`, update the entity_id in:
- `homeassistant_config/accuweather_forcast.yaml` (line 15)
- `weather/weather_today.yaml` (lines 6, 13)

### Change Update Frequency

In `homeassistant_config/accuweather_forcast.yaml`, modify the trigger:
```yaml
trigger:
  - trigger: time_pattern
    hours: /1  # Change this value (e.g., /2 for every 2 hours)
```

### Extend Forecast Days

To show more than 4 days, add additional attributes to the template sensor and corresponding ESPHome text sensors.

## Troubleshooting

### Sensor not appearing in Home Assistant
- Check Home Assistant logs for template errors
- Verify your weather entity exists and provides forecast data
- Ensure the template configuration is loaded (check Configuration → Server Controls → Check Configuration)

### ESPHome shows default values
- Verify `sensor.weather_forecast` exists in Home Assistant
- Check ESPHome logs for connection issues
- Ensure the entity_id matches exactly (case-sensitive)

### Icons not updating
- Check that weather condition strings match those defined in `weather_icons_update.yaml`
- Verify SVG files are available in the `weather/assets` directory
- Ensure CairoSVG is installed: `pip install cairosvg`
